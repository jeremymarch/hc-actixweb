<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hoplte Challenge</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <script type="text/javascript" src="jquery.min.js"></script>
<!--    <script type="text/javascript" src="wordtree.js?v10"></script>-->
    <script>

    function setTheme() {
        var mode = localStorage.getItem("mode");
        if ((window.matchMedia( "(prefers-color-scheme: dark)" ).matches || mode == "dark") && mode != "light") {
            document.querySelector("HTML").classList.add("dark");
        }
        else {
            document.querySelector("HTML").classList.remove("dark");
        }
    }
    setTheme();    
    </script>
    <style>
        @font-face {
  		    font-family: 'WebNewAthenaUnicode';
  		src: url('/newathu5_8.ttf') format('truetype');
	}
    BODY { font-family:helvetica neue,helvetica, arial, sans-serif; }
    .gkinput, .gkinputnontyping {
        font-family: WebNewAthenaUnicode,NewAthenaUnicode, helvetica,arial;
    }
    .gkinput, .gkinputcodes, .gkinputnontyping {
    -webkit-box-sizing: border-box; /* Safari/Chrome, other WebKit */
    -moz-box-sizing: border-box;    /* Firefox, other Gecko */
    box-sizing: border-box;         /* Opera/IE 8+ */
    width: 100%;
    padding: 0px 0.5em;
    height: 40px;
    font-size: 20pt;
    border-radius: 6px;
    border: 2px solid #666;
    margin:6px 0px;
    resize: none;
}

.gkinput:focus, .gkinputcodes:focus, .gkinputnontyping:focus{
    outline:2px solid #6677dd;
}

.startingform, .newform {
    width:600px;
    display:block;
    margin:0px auto;
    height:110px;
    font-size:24pt;
    border:1px solid black;
    text-align: center;
    padding-top:20px;
    border-radius:6px;
    font-family: WebNewAthenaUnicode,NewAthenaUnicode, helvetica,arial;
}
.changedesc {
    width:600px;
    display:block;
    margin:10px auto;
    height:82px;
    font-size:24pt;
    text-align: center;
    padding-top: 36px;
}
.correctanswer {
    width:600px;
    display:block;
    margin:10px auto;
    font-size:24pt;
    text-align: center;
    height:42px;
}
#submitbutton {
    margin:10px auto;
    width:100px;
    display: block;
}
#mainstopwatch {
    float:right;
}
.hbox {
    width:600px;
    margin:10px auto;
    height:30px;
}
#askparamsdiv {
    width:600px;
    margin:0px auto;
}
#askparamsdivinner {
    width:100%;
    margin:0px auto;
}
.mfbutton {
    float:left;
    width:50px;
}

#settings {
    border:2px solid black;
    width:300px;
    float:left;
}
#creategamebutton {
    display: block;
}
#menubar {
    height:20px;
    border-bottom:1px solid black;
}
.myturn {
    background-color: red;
}
#askparamsdiv {
    display: none;
}
    </style>
    </head>
    <body onload="start()">
        <div id="menubar"><div style="float:right;font-weight:bold;">HOPLITE CHALLENGE</div></div>
        <div id="settings">
            <button id="creategamebutton" onclick="createGame()">Create Game</button>
            Top Unit: <input id="unitinput" type="text"/><br/>
            Opponent: <input id="opponentinput" type="text"/><br/>
            <button onclick="refresh()">refresh</button>
            <div id="list"></div>
        </div>
        <div class="hbox">
            <button class="mfbutton" onclick="mfclicked()" title="Multiple Forms Button">MF</button>
            <div id="mainstopwatch">
                <div id="mainTime">
                    30:00
                </div>
            </div>
            
        </div>
    <div id="startingform" class="startingform"></div>
    
    <div id="statusmesg" class="changedesc">press start to begin</div>
    <div id="changedesc" class="changedesc"></div>
    <div id="askparamsdiv">
        <div id="askparamsdivinner">
        <select id="personparam">
            <option value="0">First</option>
            <option value="1">Second</option>
            <option value="2">Third</option>
        </select>
        <select id="numberparam">
            <option value="0">Singular</option>
            <option value="1">Plural</option>
        </select>
        <select id="tenseparam">
            <option value="0">Present</option>
            <option value="1">Imperfect</option>
            <option value="2">Future</option>
            <option value="3">Aorist</option>
            <option value="4">Perfect</option>
            <option value="5">Pluperfect</option>
        </select>
        <select id="moodparam">
            <option value="0">Indicative</option>
            <option value="1">Subjunctive</option>
            <option value="2">Optative</option>
            <option value="3">Imperative</option>
        </select>
        <select id="voiceparam">
            <option value="0">Active</option>
            <option value="1">Middle</option>
            <option value="2">Passive</option>
        </select>
    </div>
    </div>
    <textarea id="answerform" class="gkinput newform disablecopypaste" disabled autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:10px;"></textarea>
    <div id="correctanswer" class="correctanswer" style="visibility: hidden;"></div>
    <button id="submitbutton" onclick="submitclicked()">Start</button>   
    <script>
            // Check for wasm support.
	if (!('WebAssembly' in window)) {
		alert('you need a browser with wasm support enabled :(');
	}
	
	function loadWebAssembly(filename, imports) {
		return fetch(filename)
		.then(response => response.arrayBuffer())
		.then(buffer => WebAssembly.compile(buffer))
		.then(module => {
			return WebAssembly.instantiate(module);
		});
	}
	
	var wasmBuffer0;
	var accentSyllableWASM;
	var transliterateWASM;
	
	var wasmBufferLength = 256;
	var memory;
	loadWebAssembly('hoplitekb.wasm', { js: { mem: memory } })
		.then(instance => {
			var exports = instance.exports;
			accentSyllableWASM = exports.accentSyllable2;
			transliterateWASM = exports.transliterate;
			memory = exports.memory;
	
			//console.log("memory: " + memory.buffer.byteLength);
	
			//https://rob-blackbourn.github.io/blog/webassembly/wasm/array/arrays/javascript/c/2020/06/07/wasm-arrays.html
			//offset is in bytes, length is in array elements
			//https://stackoverflow.com/questions/15417310/why-typed-array-constructors-require-offset-to-be-multiple-of-underlying-type-si
			var offset = 2; //don't set start at zero (null), use 2 for proper alignment
			wasmBuffer0 = new Uint16Array(memory.buffer, offset, wasmBufferLength);
			//console.log("offset0: " + offset + ", " + wasmBuffer0.byteOffset + ", " + wasmBuffer0.length);
		}
	);
	
	function strToCodePoints(str)
	{
		var a = "";
		for (var i = 0; i < str.length; i++) {
			a += str.codePointAt(i).toString(16).padStart(4,"0").toUpperCase() + " ";
		}
		return a.trim();
	}

    var timerRef = null;
    function start() {
        timerRef = document.querySelector('#mainTime');
	    const supported = (() => {
            try {
                if (typeof WebAssembly === "object"
                    && typeof WebAssembly.instantiate === "function") {
                    const module = new WebAssembly.Module(Uint8Array.of(0x0, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00));
                    if (module instanceof WebAssembly.Module)
                        return new WebAssembly.Instance(module) instanceof WebAssembly.Instance;
                }
            } catch (e) { }
            return false;
        })();
	    //console.log(supported ? "WebAssembly is supported" : "WebAssembly is not supported");
	
		$(".gkinput").keypress(handleKey);
		//$("#inp").focus();

        submit_data("", "", false, false); //get new
	}
	
	var forceLowercase = false;
	function accentSyllable(origChars, key) {
		var len = origChars.length;
		//add letter and any combining diacritics to the buffer as code points
		for (var i = 0; i < len && i < wasmBufferLength; i++) {
			wasmBuffer0[i] = origChars.codePointAt(i);
			console.log("accent1: " + origChars.codePointAt(i));
		}
		//console.log("accent1a: " + len + ", " + key);
		len = accentSyllableWASM(wasmBuffer0.byteOffset, len, key, 1, parseInt(unicodeMode) );
	
		//transform the returned code points back to a string
		var newLetter = "";
		for (var i = 0; i < len && i < wasmBufferLength; i++) {
			newLetter += String.fromCodePoint(wasmBuffer0[i]);
			//console.log("accent2: " + String.fromCodePoint(wasmBuffer0[i]));
		}
		/*
		for (var i = 0; i < 10; i++) {
			wasmBuffer0[i] = 0;
		}*/
		console.log("ptr2: " + wasmBuffer0.byteOffset + ", " + wasmBuffer0.length);
		//let win1251decoder = new TextDecoder('utf-16le');
		return newLetter;
	}
	
	var unicodeMode = 0;
	function handleKey(e) {
	
		var val = this.value;
		e = e || event;
		if (typeof(this.selectionStart) == "number" && typeof(this.selectionEnd) == "number") {
			var start = this.selectionStart;
			var end = this.selectionEnd;
			var newLetter = "";
			var replacing = 0;
			var charCode = typeof(e.which) == "number" ? e.which : e.keyCode;
			//console.log("handlekey1: " + charCode);
			var key = String.fromCharCode(charCode);
	
			if (charCode && charCode > 64 && charCode < 123) //transliterate letter
			{
				//newLetter = accentSyllable("", key.codePointAt(0));
				newLetter = String.fromCharCode( transliterateWASM( key.codePointAt(0) ) );
				//console.log("new: " + newLetter);
			}
			else if (charCode && charCode > 47 && charCode < 58) //number: 0-9 are 48-57
			{ 
				//underdot,rough,smooth,acute,grave,circ,macron,breve,iotasub,diaeresis
				var diacriticKeys = [11,5,6,1,3,2,4,10,7,9];
				var hckey = diacriticKeys[ parseInt(key) ];
	
				var combining = [0x0300, 0x0301, 0x0304, 0x0306, 0x0308, 0x0313, 0x0314, 0x0323, 0x0342, 0x0345];
				var offset = 1;
				for (var i = start; i > -1; i--) {
					if (combining.indexOf(val.codePointAt(i - 1)) > -1) {
						offset++;
					}
					else {
						break;
					}
				}
	
				unicodeMode = 0;//$("input:radio[name='unicodeMode']:checked").val();
	
				newLetter = accentSyllable(val.slice(start - offset, start), hckey);
				replacing = start - (start - offset);
			}
	
			if (newLetter.length > 0) {
				//update the input/textarea
				this.value = val.slice(0, start - replacing) + newLetter + val.slice(end);
				// Move the caret
				this.selectionStart = this.selectionEnd = (start - replacing) + newLetter.length;
				return false;
			}
		}    
		return true; //this allows most punctuation to pass through
	}

    var starting_form = null;
    var change_desc = null;
    function submit_data(answer, time, mfPressed, timedOut) {
        $.ajax({
            url: "enter",
            type: "POST",
            data: {qtype:"submit", answer:answer, time:time, mf_pressed:mfPressed, timed_out:timedOut},
            dataType: "json",//JSON automatically deserializes json
            success: function (data, textStatus, jqXHR) {
                //console.log("data: " + data[0] + "ha " + data[1]);
                //var returnObj = JSON.parse(data);

                console.log(data);
                starting_form = data.starting_form;
                change_desc = data.change_desc;
                uiModeAnswerResponseReceived(false, "correct answer");

                reqPending = false;
            },
            error: function(response) {
                console.log("error: " + response);
                reqPending = false;
            }
        });
    }

    function createGame() {
        let unitv = document.querySelector("#unitinput").value.trim();
        let opponentv = document.querySelector("#opponentinput").value.trim();
        $.ajax({
            url: "new",
            type: "POST",
            data: {qtype:"newsession", unit:unitv, opponent:opponentv},
            dataType: "json",//JSON automatically deserializes json
            success: function (data, textStatus, jqXHR) {
                //console.log("data: " + data[0] + "ha " + data[1]);
                //var returnObj = JSON.parse(data);

                console.log(data);
            },
            error: function(response) {
                console.log("error: " + response);
            }
        });
    }
    
    var session_id = null;
    function getmove(sessionid) {
        session_id = sessionid;
        $.ajax({
            url: "getmove",
            type: "POST",
            data: {session_id:sessionid},
            dataType: "json",//JSON automatically deserializes json
            success: function (data, textStatus, jqXHR) {
                //console.log("data: " + data[0] + "ha " + data[1]);
                //var returnObj = JSON.parse(data);
                setUI(data);

                // if (data.move_type == "1") {
                //     uiModeAskForm();
                //     //show verb and form selectors
                //     //hide textarea, orig form will display verb selector, hide timer
                // }

                console.log("getmovedata: " + data);
                //document.querySelector("#list").innerHTML = rows;
            },
            error: function(response) {
                console.log("error: " + response);
            }
        });
    }

    function refresh() {
        $.ajax({
            url: "list",
            type: "POST",
            data: {practice:true,game:true},
            dataType: "json",//JSON automatically deserializes json
            success: function (data, textStatus, jqXHR) {
                //console.log("data: " + data[0] + "ha " + data[1]);
                //var returnObj = JSON.parse(data);

                console.log(data);
                let rows = "";
                for (var i = 0; i < data.length; i++) {
                    rows += "<p" + ((data[i].myturn) ? " class='myturn'" : "") + "><a href='#' onclick='getmove(\"" + data[i].session_id + "\")'>" + data[i].timestamp + ((data[i].opponent_name) ? " vs. " + data[i].opponent_name : "") + "(" + data[i].move_type + ")</a></p>";
                }
                document.querySelector("#list").innerHTML = rows;
            },
            error: function(response) {
                console.log("error: " + response);
            }
        });
    }
    
    function submit_ask(session_id, person, number, tense, mood, voice, verb) {
        $.ajax({
            url: "ask",
            type: "POST",
            data: {session_id: session_id, person: person, number: number, tense: tense, mood: mood, voice: voice, verb: verb},
            dataType: "json",//JSON automatically deserializes json
            success: function (data, textStatus, jqXHR) {
                //console.log("data: " + data[0] + "ha " + data[1]);
                //var returnObj = JSON.parse(data);
                if (data.qtype == "askresponse" && data.success) {
                    uiModeAskResponse();
                }

                console.log(data);
            },
            error: function(response) {
                console.log("error: " + response);
            }
        });
    }

    function get_param_values() {
        let p = document.querySelector("#personparam").value;
        let n = document.querySelector("#numberparam").value;
        let t = document.querySelector("#tenseparam").value;
        let m = document.querySelector("#moodparam").value;
        let v = document.querySelector("#voiceparam").value;

        console.log("vals: " + p + n + t + m + v);
        return [p,n,t,m,v];
    }

//0 practice, always my turn
//1 no moves have not been asked, I am challenger (I need to ask, it's my turn)
//2 no moves have been asked
//3 q has not been answered by me
//4 q has not been asked by me
//5 q has not been asked by you
//6 q has not been answered by you
//7 game has ended (no ones turn)
    function setUI(data) {
        switch(data.move_type) {
            case 0: 
                uiModePractice(); //practice
                break;
            case 1: 
                uiModeAskForm(); //I need to ask first move
                break;
            case 2: 
                uiModeWaitingForAsk(); //no moves: waiting for other player to ask first move
                break;
            case 3: 
                uiModeAnwerForm(data.starting_form, desc(data.person, data.number, data.tense, data.voice, data.mood)); //I need to answer
                break;
            case 4: 
                uiModeAskForm(); //I need to ask
                break;
            case 5: 
                uiModeWaitingForAsk(); //waiting for you to ask
                break;
            case 6: 
                uiModeWaitingForAnswer(); //waiting for you to answer
                break;
            case 7: 
                uiModeGameIsOver(); //game has ended
                break;
            default:
                break;
        }
    }

    var persons = ["first", "second", "third"];
    var numbers = ["singular", "plural"];
    var tenses = ["present", "imperfect", "future", "aorist", "perfect", "pluperfect"];
    var voices  = ["active", "middle", "passive"];
    var moods = ["indicative", "subjunctive", "optative", "imperative"];
    function desc(person, number, tense, voice, mood) {
        return persons[person] + " " + numbers[number] + " " + tenses[tense] + " " + moods[mood] + " " + voices[voice];
    }

    function uiModeGameIsOver() {
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.disabled = true;
        document.querySelector("#statusmesg").innerHTML = "Game is over.";
        document.querySelector("#answerform").value = "";
        document.querySelector("#answerform").disabled = true;
        document.querySelector("#correctanswer").innerHTML = "";
        document.querySelector("#correctanswer").style.visibility = "hidden";
        document.querySelector("#startingform").innerText = "";
    }

    function uiModePractice() {
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.disabled = true;
        document.querySelector("#statusmesg").innerHTML = "Practice Mode";
        document.querySelector("#answerform").value = "";
        document.querySelector("#answerform").disabled = true;
        document.querySelector("#correctanswer").innerHTML = "";
        document.querySelector("#correctanswer").style.visibility = "hidden";
        document.querySelector("#startingform").innerText = "";

        document.querySelector("#askparamsdiv").style.display = "none";
    }

    function uiModeAnwerForm(starting_form, change_desc) {
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.disabled = false;
        submitbutton.innerText = "Go";
        document.querySelector("#statusmesg").innerHTML = "Click Go to answer!"
        document.querySelector("#changedesc").innerHTML = change_desc;
        document.querySelector("#answerform").value = "";
        document.querySelector("#answerform").disabled = true;
        document.querySelector("#correctanswer").innerHTML = "";
        document.querySelector("#correctanswer").style.visibility = "hidden";
        document.querySelector("#startingform").innerText = starting_form;

        document.querySelector("#askparamsdiv").style.display = "none";
    }

    function uiModeWaitingForAnswer() {
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.disabled = true;
        document.querySelector("#statusmesg").innerHTML = "Waiting for (user) to answer.";
        document.querySelector("#answerform").value = "";
        document.querySelector("#answerform").disabled = true;
        document.querySelector("#correctanswer").innerHTML = "";
        document.querySelector("#correctanswer").style.visibility = "hidden";
        document.querySelector("#startingform").innerText = "";

        document.querySelector("#askparamsdiv").style.display = "none";
    }

    function uiModeWaitingForAsk() {
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.disabled = true;
        document.querySelector("#statusmesg").innerHTML = "Waiting for (user) to ask.";
        document.querySelector("#answerform").value = "";
        document.querySelector("#answerform").disabled = true;
        document.querySelector("#correctanswer").innerHTML = "";
        document.querySelector("#correctanswer").style.visibility = "hidden";
        document.querySelector("#startingform").innerText = "";

        document.querySelector("#askparamsdiv").style.display = "none";
    }

    function uiModeAskResponse() {
        
        console.log("ask successfully submitted");
    }
    function uiModeAskForm() {
        
        document.querySelector("#askparamsdiv").style.display = "block";
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.innerText = "Ask";
        submitbutton.disabled = false;
        document.querySelector("#statusmesg").innerHTML = "Change up to (2) params.";
    }
    function uiModeClickedEnter() {
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.innerText = "Loading...";
        submitbutton.disabled = true;
        stopTimer();
        document.querySelector("#answerform").disabled = true;
    }
    function uiModeClickedContinue(loc_starting_form, loc_change_desc) {
        let submitbutton = document.querySelector("#submitbutton");
        mfPressed = false;
        timedOut = false;
        submitbutton.innerText = "Enter";
        //display startform
        document.querySelector("#startingform").innerText = loc_starting_form;
        //display change desc
        document.querySelector("#changedesc").innerHTML = loc_change_desc;
        
        //clear and enable text field
        document.querySelector("#answerform").value = "";
        document.querySelector("#answerform").disabled = false;
        document.querySelector("#answerform").focus();

        document.querySelector("#correctanswer").innerHTML = "";
        document.querySelector("#correctanswer").style.visibility = "hidden";

        //start timer
        startTimer();
    }
    function uiModeAnswerResponseReceived(is_correct, correct_answer) {
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.innerText = "Continue";
        submitbutton.disabled = false;
        //mark (in)correct, show correct answer
        document.querySelector("#correctanswer").style.visibility = "visible";
        document.querySelector("#correctanswer").innerHTML = correct_answer;
    }

    var reqPending = false;
    function submitclicked() {
        let submitbutton = document.querySelector("#submitbutton");
        if (submitbutton.innerText == "Enter") {
            uiModeClickedEnter();

            reqPending = true;
            let answer = document.querySelector("#answerform").value.trim();
            let time = document.querySelector("#mainTime").innerText.trim();
            console.log("Enter clicked: " + answer + ", time: " + time + ", mfPressed: " + mfPressed + ", timedout: " + timedOut);
            //get iscorrect and correct answer if wrong
            submit_data(answer, time, mfPressed, timedOut);
        }
        else if (submitbutton.innerText == "Continue" || submitbutton.innerText == "Start") {
            console.log(submitbutton.innerText + " clicked");
            //get starting form, change desc, (and maybe whether this form has multiple forms?)
            uiModeClickedContinue(starting_form, change_desc);
        }
        else if (submitbutton.innerText == "Ask") {
            let vals = get_param_values();
            let verb_id = 0;
            submit_ask(session_id, vals[0], vals[1], vals[2], vals[3], vals[4], verb_id);
        }
    }

    var mfPressed = false;
    var timedOut = false;
    function mfclicked() {
        console.log("multiple forms clicked");
        mfPressed = true;
    }

    function timeout() {
        console.log("timed out");
        clearInterval(timer);
        timedOut = true;
        timerRef.innerHTML = "<span style=\"color:red;font-weight:bold;\">00:00</span>";
        submitclicked();
    }

    var timer = null;
    var countDownDate = null;
    var timerRunning = false;
    var seconds = 30;
    function startTimer() {
        countDownDate = new Date().getTime() + (seconds * 1000);
        timer = setInterval(interval, 10);
        timerRunning = true;
    }
    function stopTimer() {
        clearInterval(timer);
        timer = null;
        timerRunning = false;
    }
    function interval() {
        var now = new Date().getTime();
        var distance = countDownDate - now;

        //var days = Math.floor(distance / (1000 * 60 * 60 * 24));
        //var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((distance % (1000 * 60)) / 1000);
        var ms = Math.floor((distance % (1000)) / 10);

        if (distance <= 0) {
            timeout();
            return;
        }

        timerRef.innerHTML = ((minutes > 0) ? ((minutes < 10) ? ("0" + minutes + ":") : minutes + ":") : "") + ((seconds < 10) ? ("0" + seconds + ":") : seconds + ":") + ((ms < 10) ? ("0" + ms) : ms);
    }

    $(document).ready(function () {
    $('.disablecopypaste').bind('paste', function (e) {
       e.preventDefault();
    });
  });
    </script>
</body>
</html>
