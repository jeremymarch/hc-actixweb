<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hoplite Challenge</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<!--
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="wordtree.js?v10"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" 
        integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" 
        crossorigin="anonymous"></script>
-->
<script>

    function setTheme() {
        var mode = localStorage.getItem("mode");
        if ((window.matchMedia( "(prefers-color-scheme: dark)" ).matches || mode == "dark") && mode != "light") {
            document.querySelector("HTML").classList.add("dark");
        }
        else {
            document.querySelector("HTML").classList.remove("dark");
        }
    }
    setTheme();    
    </script>
    <style>
@font-face {
    font-family: 'WebNewAthenaUnicode';
    src: url('/newathu5_8.ttf') format('truetype');
}
BODY { font-family:helvetica neue,helvetica, arial, sans-serif;margin:0px; }
.gkinput, .gkinputnontyping {
    font-family: WebNewAthenaUnicode,NewAthenaUnicode, helvetica,arial;
}

.sym {
    font-family: "AppleColorEmoji","Apple Color Emoji","Segoe UI Emoji",'Noto Color Emoji',"NotoColorEmoji","Segoe UI Symbol","EmojiSymbols",Symbola,"Android Emoji","AndroidEmoji","Arial Unicode MS","Zapf Dingbats","AppleSDGothicNeo-Regular","lucida grande",tahoma,verdana,arial,sans-serif;
    text-rendering: optimizeLegibility;
}
.gkinput, .gkinputcodes, .gkinputnontyping {
    -webkit-box-sizing: border-box; /* Safari/Chrome, other WebKit */
    -moz-box-sizing: border-box;    /* Firefox, other Gecko */
    box-sizing: border-box;         /* Opera/IE 8+ */
    width: 100%;
    padding: 0px 0.5em;
    height: 40px;
    font-size: 20pt;
    margin:6px 0px;
    resize: none;
}

/*.gkinput:focus, .gkinputcodes:focus, .gkinputnontyping:focus{
    outline:2px solid #6677dd;
}*/

.startingform {
    width:100%;
    display:block;
    margin:0px auto;
    height:40px;
    font-size:24pt;
    border:1px solid black;
    text-align: center;
    padding-top:20px;
    border-radius:6px;
    font-family: WebNewAthenaUnicode,NewAthenaUnicode, helvetica,arial;
}
.newform {
    width:100%;
    display:block;
    margin:0px auto;
    height:60px;
    font-size:24pt;
    border:1px solid black;
    text-align: center;
    padding-top:20px;
    border-radius:6px;
    font-family: WebNewAthenaUnicode,NewAthenaUnicode, helvetica,arial;
}
.changedesc {
    width:100%;
    display:block;
    margin:10px auto;
    height:42px;
    font-size:16pt;
    text-align: center;
    padding-top: 16px;
}
#statusmesg {
    display: block;
    margin: 0px auto;
    font-size: 12pt;
    text-align: center;
    border-top: 1px solid black;
    padding-top: 4px;
}
.correctanswer {
    width:100%;
    display:block;
    margin:10px auto;
    font-size:24pt;
    text-align: center;
    height:42px;
}
#submitbutton {
    margin:10px auto;
    width:100px;
    display: block;
    margin-bottom: 20px;
}
#mainstopwatch {
    float:right;
}
.hbox {
    width:100%;
    margin:10px auto;
    height:30px;
    margin-top: 0px;
}
#askparamsdiv {
    width:100%;
    margin:0px auto;
}
#askparamsdivinner SELECT { display:block;}
#askparamsdivinner {
    width:100%;
    margin:0px auto;
    justify-content: center;
    display:flex;
}
.mfbutton {
    float:left;
    width:50px;
}

#settings {
    border:2px solid black;
    width:300px;
    position: absolute;
    top: 28px;
    left: 10px;
    padding:10px;
    height:120px;
}
.addheight{
    top:28px;
}
#list {
border:2px solid black;
    width:320px;
    position: absolute;
    top: 170px;
    left: 10px;
    transition: top 2s;
    z-index:899;
    
}
#creategamebutton {
    display: block;
}
#menubar {
    height:20px;
    border-bottom:1px solid black;
    display:flex;
    justify-content: flex-end;
    background-color:white;
    position:relative;
    z-index:900;
    padding:3px 10px;
}
.myturn {
    /* background-color: red; */
}
.selectedGame {
    background-color: lightgray;
}
.myturnIcon {
    fill: red;
    width: 15px;
    top: 6px;
    position: absolute;
    right:10px;
}
#askparamsdiv {
    display: none;
}
.hcform {
    display: none;
    border: 2px solid gray;
    width: 600px;
    margin: 14px auto;
    padding: 14px 14px;
    border-radius: 8px;
    padding-bottom: 4px;
    background-color: white;
    z-index: 999;
    position: relative;
}
.icon {
    height: 26px;
    width: 26px;
}
#verbchooser {
    display: none;
}
.gamerow {
    position: relative;
    padding: 4px 6px;
    margin: 8px;
}
SELECT, OPTION {
    /* font-family: WebNewAthenaUnicode,NewAthenaUnicode, helvetica,arial; */
}
.paramdiv {
    margin: 10px 4px;
    border-bottom: 4px solid white;
    padding-bottom: 4px;
}
.paramdivchanged {
    border-bottom: 4px solid red;
}

BUTTON {border-radius: 3px;}
a {color:blue;}

#refreshbutton {
    position: absolute;
    left: 7px;
    top: 3px;
}

.dark BODY { background-color: black;color:white; }
.dark .hcform { background-color: black;color:white; }
.dark .startingform {border: 1px solid white;}
.dark #statusmesg {border-top: 1px solid white;}
.dark #list {border: 2px solid white;}
.dark #settings {border: 2px solid white;}
.dark #menubar { background-color: black;color:white;border-bottom: 1px solid white; }
.dark #answerform {background-color: black;color:white;border: 1px solid white;}
.dark #mfbutton {background-color: black;color:white;border: 1px solid white;}
.dark #submitbutton {background-color: black;color:white;border: 1px solid white;}
.dark .paramdiv {border-bottom: 4px solid black;}
.dark .paramdivchanged { border-bottom: 4px solid red;}
.dark a {color:#03A5F3;}
    </style>
    </head>
    <body onload="start()">
        <div id="menubar">
            <button id="refreshbutton" onclick="get_sessions()">refresh</button>
            <div style="padding:0px 20px"><a id="loginlink" href="login">login</a>
                <span id="logoutlink" style="display:none;"><span id="username"></span> (<a href="logout">logout</a>)</span>
            </div>
            <div style="font-weight:bold;">HOPLITE CHALLENGE</div>
        </div>
        <div id="listouter">
        <div id="settings">
            <table cellpadding="4" cellspacing="0">
                <tr><td colspan="2">New Game</td></tr>
                <tr><td>Top Unit:</td><td><input id="unitinput" type="text" value="20"/></td></tr>
                <tr><td>Opponent:</td><td><input id="opponentinput" type="text"/></td></tr>
                <tr><td align="center" colspan="2"><button id="creategamebutton" onclick="new_game_clicked()">Create Game</button></td></tr>
            </table>
        </div>
        <div id="list"></div>
    </div>
        <div class="hcform">
        <div class="hbox">
            <button id="mfbutton" class="mfbutton" onclick="mf_clicked()" title="Multiple Forms Button">MF</button>
            <div id="mainstopwatch">
                <div id="mainTime">
                    30:00
                </div>
            </div>
        </div>
    <div id="startingformouter" class="startingform">
        <div id="startingform" class=""></div>
        <select id="verbchooser">
            <option value="0">παιδεύω</option>
            <option value="1">πέμπω</option>
            <option value="2">κελεύω</option>
        </select>
    </div>
    
    <div id="changedesc" class="changedesc"></div>

    <div id="askparamsdiv">
        <div id="askparamsdivinner">
            <div id="personparamdiv" class="paramdiv">
                <select id="personparam" onchange="select_changed(this)">
                    <option value="0">First</option>
                    <option value="1">Second</option>
                    <option value="2">Third</option>
                </select>
            </div>
            <div id="numberparamdiv" class="paramdiv">
                <select id="numberparam" onchange="select_changed(this)">
                    <option value="0">Singular</option>
                    <option value="1">Plural</option>
                </select>
            </div>
            <div id="tenseparamdiv" class="paramdiv">
                <select id="tenseparam" onchange="select_changed(this)">
                    <option value="0">Present</option>
                    <option value="1">Imperfect</option>
                    <option value="2">Future</option>
                    <option value="3">Aorist</option>
                    <option value="4">Perfect</option>
                    <option value="5">Pluperfect</option>
                </select>
            </div>
            <div id="moodparamdiv" class="paramdiv">
                <select id="moodparam" onchange="select_changed(this)">
                    <option value="0">Indicative</option>
                    <option value="1">Subjunctive</option>
                    <option value="2">Optative</option>
                    <option value="3">Imperative</option>
                </select>
            </div>
            <div id="voiceparamdiv" class="paramdiv">
                <select id="voiceparam" onchange="select_changed(this)">
                    <option value="0">Active</option>
                    <option value="1">Middle</option>
                    <option value="2">Passive</option>
                </select>
            </div>
        </div>
    </div>
    <textarea id="answerform" class="gkinput newform disablecopypaste" disabled autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" style="padding:10px;"></textarea>
    <div id="correctanswer" class="gkinput correctanswer" style="visibility: hidden;"></div>
    <button id="submitbutton" onclick="submit_clicked()">Start</button>
    <div id="statusmesg">press start to begin</div>
</div>

    <script>
        var myturnIcon = `<svg class="myturnIcon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50" /></svg>`;
        var correctIcon = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" enable-background="new 0 0 64 64"><path d="M32,2C15.431,2,2,15.432,2,32c0,16.568,13.432,30,30,30c16.568,0,30-13.432,30-30C62,15.432,48.568,2,32,2z M25.025,50  l-0.02-0.02L24.988,50L11,35.6l7.029-7.164l6.977,7.184l21-21.619L53,21.199L25.025,50z" fill="#43a047"/></svg>`;
        var incorrectIcon = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" enable-background="new 0 0 64 64"><path d="m32 2c-16.568 0-30 13.432-30 30s13.432 30 30 30 30-13.432 30-30-13.432-30-30-30m5.513 44.508l-5.514-9.894-5.825 9.894h-7.048l9.331-14.783-8.878-14.232h7.244l5.175 9.449 5.317-9.449h7.008l-8.878 13.996 9.429 15.02h-7.361z" fill="#e53935"/></svg>`;
            // Check for wasm support.
	if (!('WebAssembly' in window)) {
		alert('you need a browser with wasm support enabled :(');
	}

    var max_changes = null;
    function select_changed(s) {
        let changed_nodes = document.querySelectorAll(".paramdivchanged");
        if (changed_nodes && max_changes !== null && changed_nodes.length >= max_changes 
            && s.value != s.getAttribute("orig") 
            && !s.parentNode.classList.contains("paramdivchanged")) {
            s.value = s.getAttribute("orig");
        }

        if (s.value != s.getAttribute("orig") && max_changes !== null) {
            s.parentNode.classList.add("paramdivchanged");
        }
        else {
            s.parentNode.classList.remove("paramdivchanged");
        }
    }
	
	function loadWebAssembly(filename, imports) {
		return fetch(filename)
		.then(response => response.arrayBuffer())
		.then(buffer => WebAssembly.compile(buffer))
		.then(module => {
			return WebAssembly.instantiate(module);
		});
	}
	
	var wasmBuffer0;
	var accentSyllableWASM;
	var transliterateWASM;
	
	var wasmBufferLength = 256;
	var memory;
	loadWebAssembly('hoplitekb.wasm', { js: { mem: memory } })
		.then(instance => {
			var exports = instance.exports;
			accentSyllableWASM = exports.accentSyllable2;
			transliterateWASM = exports.transliterate;
			memory = exports.memory;
	
			//console.log("memory: " + memory.buffer.byteLength);
	
			//https://rob-blackbourn.github.io/blog/webassembly/wasm/array/arrays/javascript/c/2020/06/07/wasm-arrays.html
			//offset is in bytes, length is in array elements
			//https://stackoverflow.com/questions/15417310/why-typed-array-constructors-require-offset-to-be-multiple-of-underlying-type-si
			var offset = 2; //don't set start at zero (null), use 2 for proper alignment
			wasmBuffer0 = new Uint16Array(memory.buffer, offset, wasmBufferLength);
			//console.log("offset0: " + offset + ", " + wasmBuffer0.byteOffset + ", " + wasmBuffer0.length);
		}
	);
	
	function strToCodePoints(str)
	{
		var a = "";
		for (var i = 0; i < str.length; i++) {
			a += str.codePointAt(i).toString(16).padStart(4,"0").toUpperCase() + " ";
		}
		return a.trim();
	}

    var timerRef = null;
    function start() {
        timerRef = document.querySelector('#mainTime');
	    const supported = (() => {
            try {
                if (typeof WebAssembly === "object"
                    && typeof WebAssembly.instantiate === "function") {
                    const module = new WebAssembly.Module(Uint8Array.of(0x0, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00));
                    if (module instanceof WebAssembly.Module)
                        return new WebAssembly.Instance(module) instanceof WebAssembly.Instance;
                }
            } catch (e) { }
            return false;
        })();
	    //console.log(supported ? "WebAssembly is supported" : "WebAssembly is not supported");
	
        //block pasting
        let answerform = document.querySelector("#answerform");
        answerform.addEventListener('paste', (event) => {
            event.preventDefault();
        });

        answerform.addEventListener('keypress', handleKey, false);
        //$(".gkinput").keypress(handleKey);

        get_sessions();
	}
	
	var forceLowercase = false;
	function accentSyllable(origChars, key) {
		var len = origChars.length;
		//add letter and any combining diacritics to the buffer as code points
		for (var i = 0; i < len && i < wasmBufferLength; i++) {
			wasmBuffer0[i] = origChars.codePointAt(i);
			console.log("accent1: " + origChars.codePointAt(i));
		}
		//console.log("accent1a: " + len + ", " + key);
		len = accentSyllableWASM(wasmBuffer0.byteOffset, len, key, 1, parseInt(unicodeMode) );
	
		//transform the returned code points back to a string
		var newLetter = "";
		for (var i = 0; i < len && i < wasmBufferLength; i++) {
			newLetter += String.fromCodePoint(wasmBuffer0[i]);
			//console.log("accent2: " + String.fromCodePoint(wasmBuffer0[i]));
		}
		/*
		for (var i = 0; i < 10; i++) {
			wasmBuffer0[i] = 0;
		}*/
		//console.log("ptr2: " + wasmBuffer0.byteOffset + ", " + wasmBuffer0.length);
		//let win1251decoder = new TextDecoder('utf-16le');
		return newLetter;
	}
	
	var unicodeMode = 0;
	function handleKey(e) {
	
		var val = this.value;
		e = e || event;
        
		if (typeof(this.selectionStart) == "number" && typeof(this.selectionEnd) == "number") {
			var start = this.selectionStart;
			var end = this.selectionEnd;
			var newLetter = "";
			var replacing = 0;
			var charCode = typeof(e.which) == "number" ? e.which : e.keyCode;
			//console.log("handlekey1: " + charCode);
			var key = String.fromCharCode(charCode);
	
			if (charCode && charCode > 64 && charCode < 123) //transliterate letter
			{
				//newLetter = accentSyllable("", key.codePointAt(0));
				newLetter = String.fromCharCode( transliterateWASM( key.codePointAt(0) ) );
				//console.log("new: " + newLetter);
			}
			else if (charCode && charCode > 47 && charCode < 58) //number: 0-9 are 48-57
			{ 
				//underdot,rough,smooth,acute,grave,circ,macron,breve,iotasub,diaeresis
				var diacriticKeys = [11,5,6,1,3,2,4,10,7,9];
				var hckey = diacriticKeys[ parseInt(key) ];
	
				var combining = [0x0300, 0x0301, 0x0304, 0x0306, 0x0308, 0x0313, 0x0314, 0x0323, 0x0342, 0x0345];
				var offset = 1;
				for (var i = start; i > -1; i--) {
					if (combining.indexOf(val.codePointAt(i - 1)) > -1) {
						offset++;
					}
					else {
						break;
					}
				}
	
				unicodeMode = 0;
	
				newLetter = accentSyllable(val.slice(start - offset, start), hckey);
				replacing = start - (start - offset);
			}
	
			if (newLetter.length > 0) {
				//update the input/textarea
				this.value = val.slice(0, start - replacing) + newLetter + val.slice(end);
				// Move the caret
				this.selectionStart = this.selectionEnd = (start - replacing) + newLetter.length;
                //e.stopPropagation();
                e.preventDefault(); //called by default when keypress is attached with jquery and returning false
				return false;
			}
		}    
		return true; //this allows most punctuation to pass through
	}
    
    //https://github.com/le717/microajax
    function microAjax(options) {
      "use strict";

      // Default to GET
      if (!options.method) {
        options.method = "GET";
      }

      // Default empty functions for the callbacks
      function noop() {}
      if (!options.success) {
        options.success = noop;
      }
      if (!options.warning) {
        options.warning = noop;
      }
      if (!options.error) {
        options.error = noop;
      }

      var request = new XMLHttpRequest();
      request.open(options.method, options.url, true);
      //request.setRequestHeader('Content-type', 'application/json; charset=UTF-8')
      request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded; charset=UTF-8')
      request.send(options.data);

      request.onload = function() {
        // Success!
        if (request.readyState === 4 && request.status === 200) {
          options.success(JSON.parse(request.responseText));

          // We reached our target destination, but it returned an error
        } else {
          options.warning(request.responseText);
        }
      };

      // There was a connection error of some sort
      request.onerror = options.error;
    }

    function procResponseError(data) {
        console.log(data);
    }

    function procResponse(data) {
        console.log(data);

        // if (handle_response !== null) {
        //     handle_response(data);
        // }
        // else 
        if (data.response_to == "ask" && data.success) {
            uiModeAskResponse(data);
        }
        else if (data.response_to == "answerresponse" && data.success) {
            starting_form = data.starting_form;
            change_desc = data.change_desc;
            uiModeAnswerResponseReceived(data);
        }
        else if (data.response_to == "mfpressedresponse" && data.success) {
            if (data.is_correct == false) {
                uiModeClickedEnter();
            
                starting_form = data.starting_form;
                change_desc = data.change_desc;
                uiModeAnswerResponseReceived(data);

                reqPending = false;
            }
        }
        else if (data.response_to == "newsession" && data.success) {
            
        }
        else if (data.response_to == "getmoves" && data.success) {
            setUI(data);
        }
        else if (data.response_to == "getsessions" && data.success) {
            let rows = "";
            for (var i = 0; i < data.sessions.length; i++) {
                if (data.sessions[i].move_type != "FirstMoveTheirTurn") {
                    rows += "<p class='gamerow" + ((data.sessions[i].myturn) ? " myturn" : "") + "' opponent='" + data.sessions[i].opponent_name + "'><a href='#' title='" + data.sessions[i].move_type + "'' onclick='get_move(this,\"" + data.sessions[i].session_id + "\");return false;'>" + ((data.sessions[i].move_type == "Practice") ? "Practise" : "Game") + ((data.sessions[i].opponent_name) ? " vs. " + data.sessions[i].opponent_name : "") + "</a> " + ((data.sessions[i].myturn) ? myturnIcon : "") + "</p>";
                }
            }
            document.querySelector("#list").innerHTML = rows;

            if (data.username) {
                document.querySelector("#loginlink").style.display = "none";
                document.querySelector("#logoutlink").style.display = "inline";
                document.querySelector("#username").innerText = data.username;
            }
            else {
                document.querySelector("#loginlink").style.display = "inline";
                document.querySelector("#logoutlink").style.display = "none";
                document.querySelector("#username").innerText = "";
            }
        }
    }

    function serialize(obj) {
        var str = [];
        for (var p in obj)
        if (obj.hasOwnProperty(p)) {
            str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
        }
        return str.join("&");
    }

    function generic_send_request(send_url, send_data, handle_response) {
        send_data = serialize(send_data);
        microAjax({
          url: send_url,
          method: "POST",
          data: send_data,
          success: procResponse,
          warning: procResponseError,
          error: null
        });

        // $.ajax({
        //     url: send_url,
        //     type: "POST",
        //     data: send_data,
        //     dataType: "json",
        //     success: function (data, textStatus, jqXHR) {
        //          procResponse(data);
        //     },
        //     error: function(response) {
        //         console.log("error: " + response);
        //     }
        // });
    }

    function send_ask(session_id, person, number, tense, mood, voice, verb_id) {
        let send_data = {session_id: session_id, person: person, number: number, tense: tense, mood: mood, voice: voice, verb: verb_id};
        generic_send_request("ask", send_data, null);
    }

    var starting_form = null;
    var change_desc = null;
    function send_answer(answer, time, mfPressed, timedOut) {

        let send_data = {qtype:"submit", answer:answer, time:time, mf_pressed:mfPressed, timed_out:timedOut, session_id:session_id};
        generic_send_request("enter", send_data, null);
    }

    function send_mf(answer, time, mfPressed, timedOut) {

        let send_data = {qtype:"mfpressed", answer:answer, time:time, mf_pressed:mfPressed, timed_out:timedOut, session_id:session_id};
        generic_send_request("mf", send_data, null);
    }

    function new_game_clicked() {
        let unitv = document.querySelector("#unitinput").value.trim();
        let opponentv = document.querySelector("#opponentinput").value.trim();

        let send_data = {qtype:"newsession", unit:unitv, opponent:opponentv};
        generic_send_request("new", send_data, null);
    }

    var reqPending = false;
    function submit_clicked() {
        let submitbutton = document.querySelector("#submitbutton");
        if (submitbutton.innerText == "Enter") {
            uiModeClickedEnter();

            reqPending = true;
            let answer = document.querySelector("#answerform").value.trim();
            let time = document.querySelector("#mainTime").innerText.trim();
            console.log("Enter clicked: " + answer + ", time: " + time + ", mfPressed: " + mfPressed + ", timedout: " + timedOut);
        
            send_answer(answer, time, mfPressed, timedOut);
        }
        else if (submitbutton.innerText == "Continue" || submitbutton.innerText == "Start") {
            console.log(submitbutton.innerText + " clicked");
            if (practice) {
                let send_data = {session_id:session_id};
                generic_send_request("getmove", send_data, null);
            }
            else {
                uiModeAskForm2();
            }
        }
        else if (submitbutton.innerText == "Ask") {
            let vals = get_param_values();
            send_ask(session_id, vals[0], vals[1], vals[2], vals[3], vals[4], vals[5]);
        }
        else if (submitbutton.innerText == "Go") {
            console.log(submitbutton.innerText + " clicked");
            uiModeAnwerGoForm(starting_form, change_desc);
        }
    }

    var mfPressed = false;
    var timedOut = false;
    function mf_clicked() {
        console.log("multiple forms clicked");
        mfPressed = true;

        let answer = document.querySelector("#answerform").value.trim();
        let time = document.querySelector("#mainTime").innerText.trim();
        console.log("MF clicked: " + answer + ", time: " + time + ", mfPressed: " + mfPressed + ", timedout: " + timedOut);

        send_mf(answer, time, mfPressed, timedOut);
    }

    function timeout() {
        console.log("timed out");
        clearInterval(timer);
        timedOut = true;
        timerRef.innerHTML = "<span style=\"color:red;font-weight:bold;\">00:00</span>";
        submit_clicked();
    }
    
    var session_id = null;
    function get_move(therow, sessionid) {
        document.querySelectorAll(".selectedGame").forEach((row) => {
            row.classList.remove("selectedGame");
        });        
        therow.parentNode.classList.add("selectedGame");
        session_id = sessionid;

        let send_data = {session_id:sessionid};
        generic_send_request("getmove", send_data, null);
    }

    function get_sessions() {
        let send_data = {practice:true,game:true};
        generic_send_request("list", send_data, null);
    }

    function set_params_dropdowns(person, number, tense, voice, mood, verb_id) {
        let a = document.querySelectorAll(".paramdivchanged").forEach(e => e.classList.remove("paramdivchanged"));

        let p = document.querySelector("#personparam");
        p.value = person;
        p.setAttribute("orig", person);
        let n = document.querySelector("#numberparam");
        n.value = number;
        n.setAttribute("orig", number);
        let t = document.querySelector("#tenseparam");
        t.value = tense;
        t.setAttribute("orig", tense);
        let m = document.querySelector("#moodparam");
        m.value = mood;
        m.setAttribute("orig", mood);
        let v = document.querySelector("#voiceparam");
        v.value = voice;
        v.setAttribute("orig", voice);
        let vc = document.querySelector("#verbchooser");
        //if the dropdown doesn't have enough rows to assign value, just add a new row for it. it's ok: we can't see it
        if (verb_id >= vc.options.length && vc.value != verb_id /* so we don't get two of same option */) {
            var option = document.createElement("option");
                option.value = verb_id;
                option.text = "";
            vc.add(option);
        }
        vc.value = verb_id;
    }

    function get_param_values() {
        let p = document.querySelector("#personparam").value;
        let n = document.querySelector("#numberparam").value;
        let t = document.querySelector("#tenseparam").value;
        let m = document.querySelector("#moodparam").value;
        let v = document.querySelector("#voiceparam").value;
        let verb_id = document.querySelector("#verbchooser").value;

        //console.log("vals: " + p + n + t + m + v + verb_id);
        return [p,n,t,m,v,verb_id];
    }

    function setUI(data) {
        practice = false;
        document.querySelector(".hcform").style.display = "block";
        switch(data.move_type) {
            case "Practice": 
                uiModePractice(data); //practice
                break;
            case "FirstMoveMyTurn": 
                uiModeAskForm(data, 5); //I need to ask first move
                break;
            case "FirstMoveTheirTurn": 
                uiModeWaitingForAsk(data); //no moves: waiting for other player to ask first move
                break;
            case "AnswerMyTurn": 
                uiModeAnwerForm(data); //I need to answer
                break;
            case "AskTheirTurn":     
                uiModeWaitingForAsk(data); //waiting for you to ask
                break;
            case "AskMyTurn": 
                uiModeAskForm(data, 2); //I need to ask
                break;
            case "AnswerTheirTurn": 
                uiModeWaitingForAnswer(data); //waiting for you to answer
                break;
            case "GameOver": 
                uiModeGameIsOver(); //game has ended
                break;
            default:
                break;
        }
    }

    var persons = ["first", "second", "third"];
    var numbers = ["singular", "plural"];
    var tenses = ["present", "imperfect", "future", "aorist", "perfect", "pluperfect"];
    var voices  = ["active", "middle", "passive"];
    var moods = ["indicative", "subjunctive", "optative", "imperative"];
    function desc(person, number, tense, mood, voice, prevp, prevn, prevt, prevm, prevv) {
        if (person !== prevp && prevp !== null) {
            person = "<b>" + persons[person] + "</b>";
        }
        else {
            person = persons[person];
        }
        if (number !== prevn && prevn !== null) {
            number = "<b>" + numbers[number] + "</b>";
        }
        else {
            number = numbers[number];
        }
        if (tense !== prevt && prevt !== null) {
            tense = "<b>" + tenses[tense] + "</b>";
        }
        else {
            tense = tenses[tense];
        }
        if (mood !== prevm && prevm !== null) {
            mood = "<b>" + moods[mood] + "</b>";
        }
        else {
            mood = moods[mood];
        }
        if (voice !== prevv && prevv !== null) {
            voice = "<b>" + voices[voice] + "</b>";
        }
        else {
            voice = voices[voice];
        }
        return person + " " + number + " " + tense + " " + mood + " " + voice;
    }

    function uiModeGameIsOver() {
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.disabled = true;
        document.querySelector("#statusmesg").innerHTML = "Game is over.";
        document.querySelector("#answerform").value = "";
        document.querySelector("#answerform").disabled = true;
        document.querySelector("#correctanswer").innerHTML = "";
        document.querySelector("#correctanswer").style.visibility = "hidden";
        document.querySelector("#startingform").innerText = "";
        document.querySelector("#mfbutton").disabled = true;
        document.querySelector("#verbchooser").style.display = "none";
    }

    //need to set prev params for first form
    function uiModePractice(data) {
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.disabled = false;
        submitbutton.innerText = "Go";
        starting_form = data.starting_form;
        change_desc = desc(data.person, data.number, data.tense, data.mood, data.voice, data.person_prev, data.number_prev, data.tense_prev, data.mood_prev, data.voice_prev);
        //document.querySelector("#statusmesg").innerHTML = "Click Go to answer!"
        document.querySelector("#statusmesg").innerHTML = "Practice Mode";
        document.querySelector("#changedesc").innerHTML = (data.person_prev !== null) ? desc(data.person_prev, data.number_prev, data.tense_prev, data.mood_prev, data.voice_prev, null, null, null, null, null) : "";
        document.querySelector("#answerform").value = "";
        document.querySelector("#answerform").disabled = true;
        document.querySelector("#mfbutton").disabled = true;
        document.querySelector("#correctanswer").innerHTML = "";
        document.querySelector("#correctanswer").style.visibility = "hidden";
        document.querySelector("#startingform").innerText = (data.starting_form) ? data.starting_form : "";

        document.querySelector("#askparamsdiv").style.display = "none";
        document.querySelector("#submitbutton").style.display = "block";
        document.querySelector("#verbchooser").style.display = "none";
    }

    function uiModeAnwerForm(data) {
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.disabled = false;
        submitbutton.innerText = "Go";
        starting_form = data.starting_form;
        change_desc = desc(data.person, data.number, data.tense, data.mood, data.voice, data.person_prev, data.number_prev, data.tense_prev, data.mood_prev, data.voice_prev);
        document.querySelector("#statusmesg").innerHTML = "Click Go to answer!"
        document.querySelector("#changedesc").innerHTML = (data.person_prev !== null) ? desc(data.person_prev, data.number_prev, data.tense_prev, data.mood_prev, data.voice_prev, null, null, null, null, null) : "";
        document.querySelector("#answerform").value = "";
        document.querySelector("#answerform").disabled = true;
        document.querySelector("#mfbutton").disabled = true;
        document.querySelector("#correctanswer").innerHTML = "";
        document.querySelector("#correctanswer").style.visibility = "hidden";
        document.querySelector("#startingform").innerText = (data.starting_form) ? data.starting_form : "";

        document.querySelector("#askparamsdiv").style.display = "none";
        document.querySelector("#submitbutton").style.display = "block";
        document.querySelector("#verbchooser").style.display = "none";
    }

    function uiModeAnwerGoForm(loc_starting_form, loc_change_desc) {
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.disabled = false;
        submitbutton.innerText = "Enter";
        document.querySelector("#statusmesg").innerHTML = "Click enter to submit!"
        document.querySelector("#changedesc").innerHTML = loc_change_desc;
        document.querySelector("#answerform").value = "";
        document.querySelector("#answerform").disabled = false;
        document.querySelector("#mfbutton").disabled = false;
        document.querySelector("#answerform").focus();
        document.querySelector("#correctanswer").innerHTML = "";
        document.querySelector("#correctanswer").style.visibility = "hidden";
        document.querySelector("#startingform").innerText = loc_starting_form;

        document.querySelector("#askparamsdiv").style.display = "none";
        startTimer();
        document.querySelector("#submitbutton").style.display = "block";
        document.querySelector("#verbchooser").style.display = "none";
    }

    function uiModeClickedContinue(loc_starting_form, loc_change_desc) {
        let submitbutton = document.querySelector("#submitbutton");
        mfPressed = false;
        timedOut = false;
        submitbutton.innerText = "Enter";
        //display startform
        document.querySelector("#startingform").innerText = loc_starting_form;
        //display change desc
        document.querySelector("#changedesc").innerHTML = loc_change_desc;
        
        //clear and enable text field
        document.querySelector("#answerform").value = "";
        document.querySelector("#answerform").disabled = false;
        document.querySelector("#answerform").focus();

        document.querySelector("#correctanswer").innerHTML = "";
        document.querySelector("#correctanswer").style.visibility = "hidden";
        document.querySelector("#mfbutton").disabled = true;
        document.querySelector("#verbchooser").style.display = "none";

        //start timer
        startTimer();
    }

    function uiModeWaitingForAnswer(data) {
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.disabled = true;
        document.querySelector("#statusmesg").innerHTML = "Waiting for (user) to answer.";
        document.querySelector("#answerform").value = "";
        document.querySelector("#answerform").disabled = true;
        document.querySelector("#correctanswer").innerHTML = "";
        document.querySelector("#correctanswer").style.visibility = "hidden";
        document.querySelector("#startingform").innerText = data.starting_form;

        document.querySelector("#askparamsdiv").style.display = "none";

        document.querySelector("#changedesc").innerHTML = desc(data.person, data.number, data.tense, data.mood, data.voice, data.person_prev, data.number_prev, data.tense_prev, data.mood_prev, data.voice_prev);
        document.querySelector("#submitbutton").style.display = "none";
        document.querySelector("#mfbutton").disabled = true;
        document.querySelector("#mainTime").innerText = "30:00";
        document.querySelector("#verbchooser").style.display = "none";
    }

    function uiModeWaitingForAsk(data) {
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.disabled = true;
        document.querySelector("#statusmesg").innerHTML = "Waiting for (user) to ask.";
        document.querySelector("#answerform").value = data.answer;
        document.querySelector("#answerform").disabled = true;
        
        document.querySelector("#correctanswer").style.visibility = "visible";
        document.querySelector("#startingform").innerText = data.starting_form;
        
        document.querySelector("#mainTime").innerText = data.time;
        document.querySelector("#askparamsdiv").style.display = "none";
        document.querySelector("#submitbutton").style.display = "none";
        document.querySelector("#mfbutton").disabled = true;

        if (data.move_type == "FirstMoveTheirTurn") {
            document.querySelector("#changedesc").innerHTML = "";
            document.querySelector("#correctanswer").innerHTML = "";
        }
        else {
            document.querySelector("#changedesc").innerHTML = desc(data.person, data.number, data.tense, data.mood, data.voice, data.person_prev, data.number_prev, data.tense_prev, data.mood_prev, data.voice_prev);
            document.querySelector("#correctanswer").innerHTML = ((data.is_correct) ? correctIcon : incorrectIcon) + " " + data.correct_answer;
        }
        document.querySelector("#verbchooser").style.display = "none";
    }

    function uiModeAskResponse(data) {
        
        console.log("ask successfully submitted");
        document.querySelector("#mfbutton").disabled = true;
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.innerText = "Sent!";
        document.querySelector("#statusmesg").innerHTML = "Sent!";
        submitbutton.disabled = true;
        document.querySelector("#askparamsdiv").style.display = "none";
        document.querySelector("#verbchooser").style.display = "none";
        if (data.starting_form) {
            document.querySelector("#startingform").innerText = data.starting_form;
        }
        document.querySelector("#changedesc").innerHTML = desc(data.person, data.number, data.tense, data.mood, data.voice, data.person_prev, data.number_prev, data.tense_prev, data.mood_prev, data.voice_prev);
    }

    var global_session_state = null;
    function uiModeAskForm(data, max_params_to_change) {
        global_session_state = data;
        set_params_dropdowns(data.person, data.number, data.tense, data.voice, data.mood, data.verb);

        if (data.move_type == "FirstMoveMyTurn") {
            uiModeAskForm2();
            return;
        }

        document.querySelector("#mfbutton").disabled = true;
        let submitbutton = document.querySelector("#submitbutton");
        if (data.move_type == "Practice") {
            submitbutton.innerText = "Ask";
            document.querySelector("#verbchooser").style.display = "none";
            document.querySelector("#askparamsdiv").style.display = "block";
            document.querySelector("#statusmesg").innerHTML = "Click ask to ask this form."
            document.querySelector("#startingform").innerText = "";
            document.querySelector("#changedesc").innerHTML = "";
            document.querySelector("#answerform").value = "";
            document.querySelector("#correctanswer").style.visibility = "hidden";
            document.querySelector("#correctanswer").innerHTML = "";
        }
        else {
            submitbutton.innerText = "Continue";
            document.querySelector("#verbchooser").style.display = "none";
            document.querySelector("#mainTime").innerText = data.time;
            document.querySelector("#askparamsdiv").style.display = "none";
            document.querySelector("#statusmesg").innerHTML = "Click Continue to ask the next form."
            document.querySelector("#startingform").innerText = data.starting_form;
            document.querySelector("#changedesc").innerHTML = desc(data.person, data.number, data.tense, data.mood, data.voice, data.person_prev, data.number_prev, data.tense_prev, data.mood_prev, data.voice_prev);
            document.querySelector("#answerform").value = data.answer;
            document.querySelector("#correctanswer").style.visibility = "visible";
            document.querySelector("#correctanswer").innerHTML = ((data.is_correct) ? correctIcon : incorrectIcon) + " " + data.correct_answer;
        }
        submitbutton.style.display = "block";
        submitbutton.disabled = false;
    }

    function uiModeAskForm2() {
        let data = global_session_state;
        global_session_state = null;
        
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.innerText = "Ask";
        submitbutton.style.display = "block";
        submitbutton.disabled = false;
        document.querySelector("#mfbutton").disabled = true;
        if (data.move_type == "FirstMoveMyTurn") {
            max_changes = null; //can change all
            set_params_dropdowns(null, null, null, null, null, null);
            let verbchooser = document.querySelector("#verbchooser");
            //remove verb options
            while (verbchooser.options.length > 0) {                
                verbchooser.remove(0);
            }
            //add new verb options
            for (var v = 0; v < data.verbs.length; v++) {
                var option = document.createElement("option");
                option.value = data.verbs[v].id;
                option.text = data.verbs[v].verb;
                verbchooser.add(option);
            }
            verbchooser.value = null;
        
            document.querySelector("#startingform").innerText = "";
            verbchooser.style.display = "inline-block";
            document.querySelector("#statusmesg").innerHTML = "Choose a verb and set all parameters";

            
        }
        else {
            max_changes = 2;
            set_params_dropdowns(data.person, data.number, data.tense, data.voice, data.mood, data.verb);
            document.querySelector("#startingform").innerText = data.correct_answer;
            document.querySelector("#verbchooser").style.display = "none";
            document.querySelector("#statusmesg").innerHTML = "Change up to (2) parameters";
        }
        document.querySelector("#askparamsdiv").style.display = "block";
        document.querySelector("#changedesc").innerHTML = "";//desc(data.person, data.number, data.tense, data.mood, data.voice, data.person_prev, data.number_prev, data.tense_prev, data.mood_prev, data.voice_prev);
        //document.querySelector("#changedesc").style.display = "none";
        document.querySelector("#answerform").value = "";
        document.querySelector("#correctanswer").style.visibility = "hidden";
        document.querySelector("#correctanswer").innerHTML = ((data.is_correct) ? correctIcon : incorrectIcon) + " " + data.correct_answer;
        //document.querySelector("#statusmesg").innerHTML = "Click Ask to ask the next form."
        // if (max_params_to_change == 5) {
        //     document.querySelector("#statusmesg").innerHTML = "Choose a verb and set all params.";
        // }
        // else {
        //     document.querySelector("#statusmesg").innerHTML = "Change up to (" + max_params_to_change + ") params.";
        // }

    }
    function uiModeClickedEnter() {
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.innerText = "Loading...";
        submitbutton.disabled = true;
        stopTimer();
        document.querySelector("#answerform").disabled = true;
    }

    var practice = false;
    function uiModeAnswerResponseReceived(data) {
        if (data.move_type == "Practice") {
            practice = true;
        }
        else {
            practice = false;
        }
        global_session_state = data;
        let submitbutton = document.querySelector("#submitbutton");
        submitbutton.innerText = "Continue";
        submitbutton.disabled = false;
        document.querySelector("#mfbutton").disabled = true;
        //mark (in)correct, show correct answer
        document.querySelector("#correctanswer").style.visibility = "visible";
        document.querySelector("#correctanswer").innerHTML = ((data.is_correct) ? correctIcon : incorrectIcon) + " " + data.correct_answer;
        document.querySelector("#statusmesg").innerHTML = "Click Continue to ask the next form."
    }

    var timer = null;
    var countDownDate = null;
    var timerRunning = false;
    var seconds = 30;
    function startTimer() {
        countDownDate = new Date().getTime() + (seconds * 1000);
        timer = setInterval(interval, 10);
        timerRunning = true;
    }
    function stopTimer() {
        clearInterval(timer);
        timer = null;
        timerRunning = false;
    }
    function interval() {
        var now = new Date().getTime();
        var distance = countDownDate - now;

        //var days = Math.floor(distance / (1000 * 60 * 60 * 24));
        //var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((distance % (1000 * 60)) / 1000);
        var ms = Math.floor((distance % (1000)) / 10);

        if (distance <= 0) {
            timeout();
            return;
        }

        timerRef.innerHTML = ((minutes > 0) ? ((minutes < 10) ? ("0" + minutes + ":") : minutes + ":") : "") + ((seconds < 10) ? ("0" + seconds + ":") : seconds + ":") + ((ms < 10) ? ("0" + ms) : ms);
    }
    </script>
</body>
</html>
